# Документация для проекта предсказания развития сахарного диабета

## Пользовательская документация

### 1. Введение
Данный сервис предназначен для предсказания развития сахарного диабета на основе данных пациента. Приложение позволяет зарегистрироваться, войти в систему, вводить данные о пациенте и его состоянии, получая по итогу предсказания от моделей.

### 2. Регистрация и вход
- **Регистрация**: Перейдите на страницу регистрации, заполните форму (имя пользователя, email и пароль) и нажмите кнопку "Register".
- **Вход**: На странице входа введите свои учетные данные (имя пользователя и пароль) и нажмите кнопку "Login".

### 3. Использование приложения
- **Ввод данных**: После входа в систему вы попадете на страницу предсказаний. Заполните форму, указав следующие данные:
  - Возраст (AGE)
  - Пол (SEX: 1 — мужчина, 2 — женщина)
  - Индекс массы тела (BMI)
  - Среднее артериальное давление (BP)
  - Общий холестерин (tc)
  - Липопротеины низкой плотности (ldl)
  - Липопротеины высокой плотности (hdl)
  - Общий холестерин / HDL (tch)
  - Логарифм уровня триглицеридов (ltg)
  - Уровень сахара в крови (glu)
- **Получение предсказаний**: Нажмите кнопку "Predict", чтобы отправить данные и получить результаты предсказаний.
- **Тестовые данные**: Вы можете использовать кнопку "Test", чтобы автоматически заполнить форму тестовыми значениями.

### 4. Кредиты
- Каждый пользователь получает 100 кредитов при регистрации.
- Каждый запрос на предсказание списывает 10 кредитов.
- Если кредиты заканчиваются, пользователь не сможет делать новые запросы.

### 5. Выход из системы
- Чтобы выйти из системы, закройте браузер или удалите токен из локального хранилища.

---

## Техническая документация

### 1. Архитектура приложения
Приложение состоит из следующих компонентов:
- **Frontend**: HTML, CSS, JavaScript.
- **Backend**: FastAPI (файлы `main.py`, `database.py`, `models.py`).
- **API моделей**: FastAPI (файл `api.py`).
- **База данных**: SQLite, можно использовать другую, настройки указываются в `database.py`.

### 2. Установка и запуск
1. Установите Docker и Docker Compose, если они еще не установлены.
2. Клонируйте репозиторий и перейдите в директорию проекта:
   ```bash
   git clone <репозиторий>
   cd <директория_проекта>
   ```
3. Соберите и запустите контейнеры с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```
4. После успешного запуска откройте приложение в браузере по адресу http://localhost.
5. Для сохранения лога приложения в файл запустите контейнеры командой:
   ```bash
   docker-compose up --build > app.log 2>&1
   ```

### 3. API Endpoints
- **Регистрация**: `POST /register`
  - Принимает JSON с полями `username`, `email`, `password`.
- **Вход**: `POST /token`
  - Возвращает JWT токен для аутентификации.
- **Получение данных пользователя**: `GET /users/me`
  - Возвращает данные текущего пользователя.
- **Предсказания**: `POST /predict`
  - Принимает JSON с данными для предсказания и возвращает результаты.
- **Swagger UI**: Доступен по адресу `http://localhost:8000/docs`.

### 4. Аутентификация и авторизация
- Используется JWT (JSON Web Token) для аутентификации.
- Токен передается в заголовке `Authorization: Bearer <token>`.
- Токен действителен 30 минут.

### 5. Взаимодействие с моделями
- Backend отправляет данные на API моделей по адресу `http://models_api:8000/predict`.
- API моделей использует три модели:
  - Random Forest (`best_modelRF.pkl`)
  - XGBoost (`best_modelXGB.pkl`)
  - Нейронная сеть (`best_modelNN.h5`)
- Результаты предсказаний возвращаются в формате JSON.

### 6. Логика работы с кредитами
- Каждый пользователь получает 100 кредитов при регистрации.
- Каждый запрос на предсказание списывает 10 кредитов.
- Если кредитов недостаточно, запрос отклоняется.

### 7. Обновление моделей без остановки сервиса
Чтобы обновить модели в `api.py` без остановки сервиса, выполните следующие шаги:
1. Подготовьте новые модели (`best_modelRF.pkl`, `best_modelXGB.pkl`, `best_modelNN.h5`) и скейлер (`scaler.pkl`).
2. Загрузите новые файлы моделей и скейлера в директорию `models_api`.
3. Пересоберите контейнер `models_api`:
   ```bash
   docker-compose build models_api
   ```
4. Перезапустите только сервис models_api:
   ```bash
   docker-compose up -d --no-deps models_api
   ```

### 8. Дополнительные настройки
- **CORS**: Настроен для разрешения запросов с любых источников (`allow_origins=["*"]`).
- **Секретный ключ**: Убедитесь, что секретный ключ (`SECRET_KEY`) в `main.py` заменен на безопасный.
